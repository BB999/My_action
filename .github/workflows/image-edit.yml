name: Image Edit with Nano Banana Pro

on:
  workflow_dispatch:

env:
  IMAGE_PATH: 'images/noranekob_samen.png'
  ASPECT_RATIO: 'auto'
  OUTPUT_FORMAT: 'png'
  NUM_IMAGES: 1

jobs:
  # Step 1: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
  generate-prompt:
    uses: ./.github/workflows/prompt-generator.yml

  # Step 2: FALã«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  upload-image:
    needs: generate-prompt
    uses: ./.github/workflows/fal-image-upload.yml
    with:
      image_path: images/noranekob_samen.png
    secrets: inherit

  # Step 3: ç”»åƒã‚’ç·¨é›†
  edit-image:
    runs-on: ubuntu-latest
    needs: [generate-prompt, upload-image]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug - Show info
        run: |
          echo "ğŸ“· Uploaded image URL: ${{ needs.upload-image.outputs.upload-url }}"
          echo "ğŸ“ Generated prompt: ${{ needs.generate-prompt.outputs.prompt }}"

      - name: Initialize MCP session
        id: init_session
        env:
          KAMUI_CODE_PASS: ${{ secrets.KAMUI_CODE_PASS }}
        run: |
          echo "ğŸ” Initializing MCP session..."

          RESPONSE=$(curl -s -i -X POST "https://kamui-code.ai/i2i/fal/nano-banana-pro/edit" \
            -H "KAMUI-CODE-PASS: $KAMUI_CODE_PASS" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json, text/event-stream" \
            -d '{"jsonrpc":"2.0","method":"initialize","id":1,"params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"github-actions","version":"1.0.0"}}}')

          SESSION_ID=$(echo "$RESPONSE" | grep -i "mcp-session-id:" | sed 's/mcp-session-id: //i' | tr -d '\r')

          if [ -z "$SESSION_ID" ]; then
            echo "âŒ Failed to get session ID"
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "âœ… Session ID: $SESSION_ID"
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT

      - name: Submit image edit request
        id: submit
        env:
          KAMUI_CODE_PASS: ${{ secrets.KAMUI_CODE_PASS }}
          PROMPT: ${{ needs.generate-prompt.outputs.prompt }}
        run: |
          echo "ğŸš€ Submitting image edit request..."

          PROMPT_ESCAPED=$(echo "$PROMPT" | jq -Rs '.' | sed 's/^"//;s/"$//')

          echo "ğŸ“¤ Sending request with:"
          echo "  - image_url: ${{ needs.upload-image.outputs.upload-url }}"
          echo "  - aspect_ratio: ${{ env.ASPECT_RATIO }}"
          echo "  - output_format: ${{ env.OUTPUT_FORMAT }}"
          echo "  - num_images: ${{ env.NUM_IMAGES }}"

          SESSION_ID="${{ steps.init_session.outputs.session_id }}"

          RESPONSE=$(curl -s -X POST "https://kamui-code.ai/i2i/fal/nano-banana-pro/edit" \
            -H "KAMUI-CODE-PASS: $KAMUI_CODE_PASS" \
            -H "Content-Type: application/json" \
            -H "Mcp-Session-Id: $SESSION_ID" \
            -d "{\"jsonrpc\":\"2.0\",\"method\":\"tools/call\",\"id\":2,\"params\":{\"name\":\"nano_banana_pro_edit_submit\",\"arguments\":{\"prompt\":\"$PROMPT_ESCAPED\",\"image_urls\":[\"${{ needs.upload-image.outputs.upload-url }}\"],\"aspect_ratio\":\"${{ env.ASPECT_RATIO }}\",\"output_format\":\"${{ env.OUTPUT_FORMAT }}\",\"num_images\":${{ env.NUM_IMAGES }}}}}")

          echo "ğŸ“¥ Response: $RESPONSE"

          REQUEST_ID=$(echo "$RESPONSE" | jq -r '.result.content[0].text' | jq -r '.request_id')

          if [ "$REQUEST_ID" = "null" ] || [ -z "$REQUEST_ID" ]; then
            echo "âŒ No request_id in response"
            echo "Full response: $RESPONSE"
            exit 1
          fi

          echo "ğŸ”‘ Request ID: $REQUEST_ID"
          echo "request_id=$REQUEST_ID" >> $GITHUB_OUTPUT
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT

      - name: Wait and check status
        id: status
        env:
          KAMUI_CODE_PASS: ${{ secrets.KAMUI_CODE_PASS }}
        run: |
          REQUEST_ID="${{ steps.submit.outputs.request_id }}"
          SESSION_ID="${{ steps.submit.outputs.session_id }}"
          echo "â³ Checking status for request: $REQUEST_ID"

          for i in {1..40}; do
            echo "Attempt $i/40: Checking status..."

            STATUS_RESPONSE=$(curl -s -X POST "https://kamui-code.ai/i2i/fal/nano-banana-pro/edit" \
              -H "KAMUI-CODE-PASS: $KAMUI_CODE_PASS" \
              -H "Content-Type: application/json" \
              -H "Mcp-Session-Id: $SESSION_ID" \
              -d "{\"jsonrpc\":\"2.0\",\"method\":\"tools/call\",\"id\":3,\"params\":{\"name\":\"nano_banana_pro_edit_status\",\"arguments\":{\"request_id\":\"$REQUEST_ID\"}}}")

            echo "ğŸ“Š Status response: $STATUS_RESPONSE"
            STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.result.content[0].text' | jq -r '.status')

            if [ "$STATUS" = "COMPLETED" ]; then
              echo "âœ… Generation completed!"
              echo "status=completed" >> $GITHUB_OUTPUT
              break
            elif [ "$STATUS" = "FAILED" ]; then
              echo "âŒ Generation failed!"
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi

            echo "â³ Status: $STATUS - waiting 15 seconds..."
            sleep 15
          done

      - name: Get result
        id: result
        env:
          KAMUI_CODE_PASS: ${{ secrets.KAMUI_CODE_PASS }}
        run: |
          REQUEST_ID="${{ steps.submit.outputs.request_id }}"
          SESSION_ID="${{ steps.submit.outputs.session_id }}"
          echo "ğŸ“¥ Getting result for request: $REQUEST_ID"

          RESULT_RESPONSE=$(curl -s -X POST "https://kamui-code.ai/i2i/fal/nano-banana-pro/edit" \
            -H "KAMUI-CODE-PASS: $KAMUI_CODE_PASS" \
            -H "Content-Type: application/json" \
            -H "Mcp-Session-Id: $SESSION_ID" \
            -d "{\"jsonrpc\":\"2.0\",\"method\":\"tools/call\",\"id\":4,\"params\":{\"name\":\"nano_banana_pro_edit_result\",\"arguments\":{\"request_id\":\"$REQUEST_ID\"}}}")

          echo "ğŸ“¦ Result Response: $RESULT_RESPONSE"

          RESULT=$(echo "$RESULT_RESPONSE" | jq -r '.result.content[0].text')

          echo "ğŸ“¦ Result: $RESULT"

          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download images
        env:
          RESULT_JSON: ${{ steps.result.outputs.result }}
        run: |
          mkdir -p output

          echo "ğŸ“¦ Processing result..."

          URLS=$(echo "$RESULT_JSON" | jq -r '
            .images[]?.url // empty,
            .image_url // empty,
            .output?.url // empty,
            .result?.images[]?.url // empty
          ' 2>/dev/null | grep -v '^$' | head -10)

          if [ -z "$URLS" ]; then
            echo "âš ï¸ No image URLs found in result"
            echo "$RESULT_JSON" | jq '.' 2>/dev/null || echo "$RESULT_JSON"
            exit 1
          fi

          COUNT=1
          echo "$URLS" | while read -r url; do
            if [ -n "$url" ]; then
              FILENAME="edited_image_${COUNT}.${{ env.OUTPUT_FORMAT }}"
              echo "ğŸ“¥ Downloading: $url -> $FILENAME"
              curl -s -L -o "output/$FILENAME" "$url"
              COUNT=$((COUNT + 1))
            fi
          done

          echo ""
          echo "ğŸ“ Downloaded files:"
          ls -la output/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: edited-images
          path: output/
          retention-days: 7

      - name: Summary
        env:
          PROMPT: ${{ needs.generate-prompt.outputs.prompt }}
        run: |
          echo "## ğŸ¨ Image Edit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Prompt:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$PROMPT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Settings:**" >> $GITHUB_STEP_SUMMARY
          echo "- Aspect Ratio: ${{ env.ASPECT_RATIO }}" >> $GITHUB_STEP_SUMMARY
          echo "- Output Format: ${{ env.OUTPUT_FORMAT }}" >> $GITHUB_STEP_SUMMARY
          echo "- Number of Images: ${{ env.NUM_IMAGES }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ Check the **Artifacts** section below to download the edited images." >> $GITHUB_STEP_SUMMARY

  # Step 4: Discordã«é€ä¿¡
  send-to-discord:
    needs: edit-image
    uses: ./.github/workflows/discord-sender.yml
    with:
      message: "ğŸ¨ ç”»åƒç·¨é›†ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
      artifact-name: edited-images
    secrets: inherit
