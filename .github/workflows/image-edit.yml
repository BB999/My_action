name: Image Edit with Nano Banana Pro

on:
  workflow_dispatch:
    inputs:
      prompt_file:
        description: 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹'
        required: false
        type: string
        default: 'prompt/prompt/prompt.md'
      prompt:
        description: 'ç·¨é›†ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚ˆã‚Šå„ªå…ˆï¼‰'
        required: false
        type: string
      image_path:
        description: 'ç·¨é›†ã™ã‚‹ç”»åƒã®ãƒ‘ã‚¹ (ãƒªãƒã‚¸ãƒˆãƒªå†…)'
        required: true
        type: string
        default: 'images/noranekob_samen.png'
      aspect_ratio:
        description: 'ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - 21:9
          - 16:9
          - 3:2
          - 4:3
          - 5:4
          - 1:1
          - 4:5
          - 3:4
          - 2:3
          - 9:16
      output_format:
        description: 'å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ'
        required: false
        default: 'png'
        type: choice
        options:
          - jpeg
          - png
          - webp
      num_images:
        description: 'ç”Ÿæˆã™ã‚‹ç”»åƒã®æ•°'
        required: false
        default: '1'
        type: string

jobs:
  # Step 1: FALã«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  upload-image:
    uses: ./.github/workflows/fal-image-upload.yml
    with:
      image_path: ${{ inputs.image_path }}
    secrets: inherit

  # Step 2: ç”»åƒã‚’ç·¨é›†
  edit-image:
    runs-on: ubuntu-latest
    needs: upload-image
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug - Show uploaded image URL
        run: |
          echo "ğŸ“· Uploaded image URL: ${{ needs.upload-image.outputs.upload-url }}"
          echo "ğŸ“Š Upload status: ${{ needs.upload-image.outputs.upload-status }}"

      - name: Read prompt from file
        id: read_prompt
        run: |
          # ç›´æ¥å…¥åŠ›ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã‚€
          if [ -n "${{ inputs.prompt }}" ]; then
            echo "ğŸ“ Using direct prompt input"
            PROMPT="${{ inputs.prompt }}"
          elif [ -f "${{ inputs.prompt_file }}" ]; then
            echo "ğŸ“„ Reading prompt from: ${{ inputs.prompt_file }}"
            PROMPT=$(cat "${{ inputs.prompt_file }}")
          else
            echo "âŒ No prompt provided and file not found: ${{ inputs.prompt_file }}"
            exit 1
          fi

          echo "ğŸ“ Prompt content:"
          echo "$PROMPT"

          # æ”¹è¡Œã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦GitHub Outputã«ä¿å­˜
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Submit image edit request
        id: submit
        env:
          KAMUI_CODE_PASS: ${{ secrets.KAMUI_CODE_PASS }}
        run: |
          echo "ğŸš€ Submitting image edit request..."

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’JSONã‚»ãƒ¼ãƒ•ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          PROMPT='${{ steps.read_prompt.outputs.prompt }}'
          PROMPT_ESCAPED=$(echo "$PROMPT" | jq -Rs '.')

          RESPONSE=$(curl -s -X POST "https://kamui-code.ai/i2i/fal/nano-banana-pro/edit" \
            -H "KAMUI-CODE-PASS: $KAMUI_CODE_PASS" \
            -H "Content-Type: application/json" \
            -d "{
              \"prompt\": $PROMPT_ESCAPED,
              \"image_url\": \"${{ needs.upload-image.outputs.upload-url }}\",
              \"aspect_ratio\": \"${{ inputs.aspect_ratio }}\",
              \"output_format\": \"${{ inputs.output_format }}\",
              \"num_images\": ${{ inputs.num_images }}
            }")

          echo "ğŸ“¥ Response: $RESPONSE"
          REQUEST_ID=$(echo "$RESPONSE" | jq -r '.request_id')
          echo "ğŸ”‘ Request ID: $REQUEST_ID"
          echo "request_id=$REQUEST_ID" >> $GITHUB_OUTPUT

      - name: Wait and check status
        id: status
        env:
          KAMUI_CODE_PASS: ${{ secrets.KAMUI_CODE_PASS }}
        run: |
          REQUEST_ID="${{ steps.submit.outputs.request_id }}"
          echo "â³ Checking status for request: $REQUEST_ID"

          for i in {1..40}; do
            echo "Attempt $i/40: Checking status..."

            STATUS_RESPONSE=$(curl -s -X POST "https://kamui-code.ai/i2i/fal/nano-banana-pro/edit" \
              -H "KAMUI-CODE-PASS: $KAMUI_CODE_PASS" \
              -H "Content-Type: application/json" \
              -d "{\"action\": \"status\", \"request_id\": \"$REQUEST_ID\"}")

            echo "ğŸ“Š Status response: $STATUS_RESPONSE"
            STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status')

            if [ "$STATUS" = "COMPLETED" ]; then
              echo "âœ… Generation completed!"
              echo "status=completed" >> $GITHUB_OUTPUT
              break
            elif [ "$STATUS" = "FAILED" ]; then
              echo "âŒ Generation failed!"
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi

            echo "â³ Status: $STATUS - waiting 15 seconds..."
            sleep 15
          done

      - name: Get result
        id: result
        env:
          KAMUI_CODE_PASS: ${{ secrets.KAMUI_CODE_PASS }}
        run: |
          REQUEST_ID="${{ steps.submit.outputs.request_id }}"
          echo "ğŸ“¥ Getting result for request: $REQUEST_ID"

          RESULT=$(curl -s -X POST "https://kamui-code.ai/i2i/fal/nano-banana-pro/edit" \
            -H "KAMUI-CODE-PASS: $KAMUI_CODE_PASS" \
            -H "Content-Type: application/json" \
            -d "{\"action\": \"result\", \"request_id\": \"$REQUEST_ID\"}")

          echo "ğŸ“¦ Result: $RESULT"

          # GitHub Outputã«ä¿å­˜ï¼ˆæ”¹è¡Œã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download images
        run: |
          mkdir -p output

          # çµæœã‹ã‚‰URLã‚’æŠ½å‡º
          RESULT='${{ steps.result.outputs.result }}'
          echo "ğŸ“¦ Processing result..."

          # è¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§URLã‚’æŠ½å‡º
          URLS=$(echo "$RESULT" | jq -r '
            .images[]?.url // empty,
            .image_url // empty,
            .output?.url // empty,
            .result?.images[]?.url // empty
          ' 2>/dev/null | grep -v '^$' | head -10)

          if [ -z "$URLS" ]; then
            echo "âš ï¸ No image URLs found in result"
            echo "$RESULT" | jq '.' 2>/dev/null || echo "$RESULT"
            exit 1
          fi

          COUNT=1
          echo "$URLS" | while read -r url; do
            if [ -n "$url" ]; then
              FILENAME="edited_image_${COUNT}.${{ inputs.output_format }}"
              echo "ğŸ“¥ Downloading: $url -> $FILENAME"
              curl -s -L -o "output/$FILENAME" "$url"
              COUNT=$((COUNT + 1))
            fi
          done

          echo ""
          echo "ğŸ“ Downloaded files:"
          ls -la output/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: edited-images
          path: output/
          retention-days: 7

      - name: Summary
        run: |
          echo "## ğŸ¨ Image Edit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Prompt:** ${{ inputs.prompt }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Settings:**" >> $GITHUB_STEP_SUMMARY
          echo "- Aspect Ratio: ${{ inputs.aspect_ratio }}" >> $GITHUB_STEP_SUMMARY
          echo "- Output Format: ${{ inputs.output_format }}" >> $GITHUB_STEP_SUMMARY
          echo "- Number of Images: ${{ inputs.num_images }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ Check the **Artifacts** section below to download the edited images." >> $GITHUB_STEP_SUMMARY

  # Step 3: Discordã«é€ä¿¡
  send-to-discord:
    needs: edit-image
    uses: ./.github/workflows/discord-sender.yml
    with:
      message: "ğŸ¨ ç”»åƒç·¨é›†ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
      artifact-name: edited-images
    secrets: inherit
