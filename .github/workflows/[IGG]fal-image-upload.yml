name: "[IGG] FAL Image Upload"

on:
  workflow_call:
    inputs:
      image_path:
        description: 'Path to the image file to upload'
        required: true
        type: string
    outputs:
      upload-url:
        description: 'FAL upload URL'
        value: ${{ jobs.upload-to-fal.outputs.url }}
      upload-status:
        description: 'Upload status'
        value: ${{ jobs.upload-to-fal.outputs.status }}
  workflow_dispatch:
    inputs:
      image_path:
        description: 'Path to the image file to upload'
        required: true
        type: string
        default: 'images/test.png'

jobs:
  upload-to-fal:
    runs-on: ubuntu-latest

    outputs:
      url: ${{ steps.upload.outputs.url }}
      status: ${{ steps.upload.outputs.status }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: List files
      run: |
        echo "Current directory contents:"
        ls -la ./
        echo ""
        echo "Image files found:"
        find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" -type f | head -10

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install fal_client
      run: pip install fal_client

    - name: Upload image to FAL
      id: upload
      env:
        FAL_KEY: ${{ secrets.FAL_KEY }}
      run: |
        echo "Target file: '${{ inputs.image_path }}'"

        if [ ! -f "${{ inputs.image_path }}" ]; then
          echo "File not found: ${{ inputs.image_path }}"
          echo "Available files:"
          find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" -type f
          echo "url=unknown" >> $GITHUB_OUTPUT
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "File exists: ${{ inputs.image_path }}"

        URL=$(python3 -c "import fal_client; print(fal_client.upload_file('${{ inputs.image_path }}'))")

        echo "Upload successful!"
        echo "URL: $URL"
        echo "url=$URL" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Summary
      run: |
        echo "## ðŸ“¤ FAL Upload Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**File:** ${{ inputs.image_path }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ steps.upload.outputs.status }}" >> $GITHUB_STEP_SUMMARY
