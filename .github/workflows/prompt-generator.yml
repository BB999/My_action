name: Prompt Generator

on:
  workflow_call:
    outputs:
      prompt:
        description: 'Generated prompt'
        value: ${{ jobs.generate-prompt.outputs.prompt }}

jobs:
  generate-prompt:
    runs-on: ubuntu-latest
    outputs:
      prompt: ${{ steps.generate.outputs.prompt }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate situation with Claude
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ğŸ¤– Generating situation with Claude..."

          # Claude APIã§ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d '{
              "model": "claude-3-haiku-20240307",
              "max_tokens": 300,
              "messages": [{
                "role": "user",
                "content": "Generate a unique, cinematic scene description for an anime girl character in a real Japanese location. Describe her posture, the environment, lighting, and atmosphere in 2-3 sentences. Be specific about body language and surroundings. Output ONLY the English description, no explanations or labels. Example style: She leans sideways against the metal railing along the Sumida River, both arms resting loosely on top. Her upper body folds slightly forward; she shifts her weight onto one hip. Behind her, trains cross the distant bridge, sunlight glancing off windows."
              }]
            }')

          echo "ğŸ“¥ Claude Response: $RESPONSE"

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
          SITUATION=$(echo "$RESPONSE" | jq -r '.content[0].text')

          if [ "$SITUATION" = "null" ] || [ -z "$SITUATION" ]; then
            echo "âŒ Failed to generate situation"
            echo "ğŸ“¥ Full response: $RESPONSE"
            exit 1
          fi

          echo "ğŸ“ Generated situation:"
          echo "$SITUATION"

          # â‘¡ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
          SUFFIX="Placed within a live-action background that matches the illustration's posture and composition â€” while faithfully preserving the illustrated texture and style. Realistic lighting, depth of field, and subtle filming effects are applied to blend the illustration seamlessly with the real environment."

          # æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
          FINAL_PROMPT="${SITUATION} ${SUFFIX}"

          echo ""
          echo "ğŸ“ Final prompt:"
          echo "$FINAL_PROMPT"

          # GitHub Outputã«ä¿å­˜
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$FINAL_PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Summary
        env:
          PROMPT: ${{ steps.generate.outputs.prompt }}
        run: |
          echo "## ğŸ“ Prompt Generated by Claude" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$PROMPT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
