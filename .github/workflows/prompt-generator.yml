name: Prompt Generator

on:
  workflow_call:
    outputs:
      prompt:
        description: 'Generated prompt'
        value: ${{ jobs.generate-prompt.outputs.prompt }}

permissions:
  id-token: write
  contents: read

jobs:
  generate-prompt:
    runs-on: ubuntu-latest
    outputs:
      prompt: ${{ steps.extract.outputs.prompt }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read prompt.md
        id: read_prompt
        run: |
          # キャラクター説明を抽出（⓪の次の行から①の前まで）
          CHARACTER=$(sed -n '/^⓪/,/^①/{/^⓪/d;/^①/d;/^┗/d;p}' prompt/prompt/prompt.md | tr '\n' ' ' | sed 's/^ *//;s/ *$//')
          echo "character=$CHARACTER" >> $GITHUB_OUTPUT
          echo "📋 Character: $CHARACTER"

          # シチュエーション例を抽出（①の次の行から②の前まで）
          EXAMPLE=$(sed -n '/^①/,/^②/{/^①/d;/^②/d;/^┗/d;p}' prompt/prompt/prompt.md | tr '\n' ' ' | sed 's/^ *//;s/ *$//')
          echo "example=$EXAMPLE" >> $GITHUB_OUTPUT
          echo "📋 Example: $EXAMPLE"

          # 接尾辞を抽出（②の次の行から最後まで）
          SUFFIX=$(sed -n '/^②/,${/^②/d;/^┗/d;p}' prompt/prompt/prompt.md | tr '\n' ' ' | sed 's/^ *//;s/ *$//')
          echo "suffix=$SUFFIX" >> $GITHUB_OUTPUT
          echo "📋 Suffix: $SUFFIX"

      - name: Generate situation with Claude
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: agent
          direct_prompt: |
            Generate a unique, cinematic scene description for ${{ steps.read_prompt.outputs.character }} in a real Japanese location. Describe the character's posture, the environment, lighting, and atmosphere in 2-3 sentences. Be specific about body language and surroundings. Output ONLY the English description, no explanations or labels.

            Example style: ${{ steps.read_prompt.outputs.example }}

      - name: Extract and build prompt
        id: extract
        env:
          EXECUTION_FILE: ${{ steps.claude.outputs.execution_file }}
          SUFFIX: ${{ steps.read_prompt.outputs.suffix }}
        run: |
          echo "📄 Execution file: $EXECUTION_FILE"

          # Claude出力ファイルからassistantの最後のメッセージを抽出
          if [ -f "$EXECUTION_FILE" ]; then
            echo "📋 JSON structure (keys):"
            jq 'keys' "$EXECUTION_FILE"
            echo ""
            echo "📋 Full JSON:"
            jq '.' "$EXECUTION_FILE" | head -100

            # 様々なパターンを試す
            CLAUDE_OUTPUT=$(jq -r '
              if type == "array" then
                map(select(.role == "assistant")) | last | .content | if type == "array" then map(select(.type == "text")) | .[0].text else . end
              elif .turns then
                .turns | map(select(.role == "assistant")) | last | .content | if type == "array" then map(select(.type == "text")) | .[0].text else . end
              elif .messages then
                .messages | map(select(.role == "assistant")) | last | .content
              elif .response then
                .response
              elif .result then
                .result
              else
                empty
              end // empty
            ' "$EXECUTION_FILE" 2>/dev/null || echo "")
          else
            echo "❌ Execution file not found"
            CLAUDE_OUTPUT=""
          fi

          echo "🤖 Claude generated:"
          echo "$CLAUDE_OUTPUT"

          echo "📋 Suffix from prompt.md:"
          echo "$SUFFIX"

          # 最終プロンプトを生成
          FINAL_PROMPT="${CLAUDE_OUTPUT} ${SUFFIX}"

          echo ""
          echo "📝 Final prompt:"
          echo "$FINAL_PROMPT"

          # GitHub Outputに保存
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$FINAL_PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Summary
        env:
          PROMPT: ${{ steps.extract.outputs.prompt }}
        run: |
          echo "## 📝 Prompt Generated by Claude" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$PROMPT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
