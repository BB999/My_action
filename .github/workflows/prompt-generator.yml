name: Prompt Generator

on:
  workflow_call:
    outputs:
      prompt:
        description: 'Generated prompt'
        value: ${{ jobs.generate-prompt.outputs.prompt }}

permissions:
  id-token: write
  contents: read

jobs:
  generate-prompt:
    runs-on: ubuntu-latest
    outputs:
      prompt: ${{ steps.extract.outputs.prompt }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate situation with Claude
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          direct_prompt: |
            Generate a unique, cinematic scene description for an anime girl character in a real Japanese location. Describe her posture, the environment, lighting, and atmosphere in 2-3 sentences. Be specific about body language and surroundings. Output ONLY the English description, no explanations or labels.

            Example style: She leans sideways against the metal railing along the Sumida River, both arms resting loosely on top. Her upper body folds slightly forward; she shifts her weight onto one hip. Behind her, trains cross the distant bridge, sunlight glancing off windows.

      - name: Extract and build prompt
        id: extract
        env:
          CLAUDE_OUTPUT: ${{ steps.claude.outputs.response }}
        run: |
          echo "ğŸ¤– Claude generated:"
          echo "$CLAUDE_OUTPUT"

          # â‘¡ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
          SUFFIX="Placed within a live-action background that matches the illustration's posture and composition â€” while faithfully preserving the illustrated texture and style. Realistic lighting, depth of field, and subtle filming effects are applied to blend the illustration seamlessly with the real environment."

          # æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
          FINAL_PROMPT="${CLAUDE_OUTPUT} ${SUFFIX}"

          echo ""
          echo "ğŸ“ Final prompt:"
          echo "$FINAL_PROMPT"

          # GitHub Outputã«ä¿å­˜
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$FINAL_PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Summary
        env:
          PROMPT: ${{ steps.extract.outputs.prompt }}
        run: |
          echo "## ğŸ“ Prompt Generated by Claude" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$PROMPT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
