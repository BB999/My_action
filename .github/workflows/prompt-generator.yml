name: Prompt Generator

on:
  workflow_call:
    outputs:
      prompt:
        description: 'Generated prompt'
        value: ${{ jobs.generate-prompt.outputs.prompt }}

permissions:
  id-token: write
  contents: read

jobs:
  generate-prompt:
    runs-on: ubuntu-latest
    outputs:
      prompt: ${{ steps.extract.outputs.prompt }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read prompt.md
        id: read_prompt
        run: |
          # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¬æ˜ã‚’æŠ½å‡ºï¼ˆâ“ªã®æ¬¡ã®è¡Œã‹ã‚‰â‘ ã®å‰ã¾ã§ï¼‰
          CHARACTER=$(sed -n '/^â“ª/,/^â‘ /{/^â“ª/d;/^â‘ /d;/^â”—/d;p}' prompt/prompt/prompt.md | tr '\n' ' ' | sed 's/^ *//;s/ *$//')
          echo "character=$CHARACTER" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Character: $CHARACTER"

          # æ¥å°¾è¾ã‚’æŠ½å‡ºï¼ˆâ‘ ã®æ¬¡ã®è¡Œã‹ã‚‰æœ€å¾Œã¾ã§ï¼‰
          SUFFIX=$(sed -n '/^â‘ /,${/^â‘ /d;/^â”—/d;p}' prompt/prompt/prompt.md | tr '\n' ' ' | sed 's/^ *//;s/ *$//')
          echo "suffix=$SUFFIX" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Suffix: $SUFFIX"

      - name: Generate situation with Claude
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: agent
          direct_prompt: |
            Generate a unique cinematic scene description for ${{ steps.read_prompt.outputs.character }} in Japanese anime style that energizes and inspires the viewer.

      - name: Extract and build prompt
        id: extract
        env:
          EXECUTION_FILE: ${{ steps.claude.outputs.execution_file }}
          CLAUDE_RESULT: ${{ steps.claude.outputs.result }}
          SUFFIX: ${{ steps.read_prompt.outputs.suffix }}
        run: |
          echo "ğŸ“„ Execution file: $EXECUTION_FILE"
          echo "ğŸ“„ Claude result output: $CLAUDE_RESULT"

          # ã¾ãšClaude Code Actionã®resultå‡ºåŠ›ã‚’è©¦ã™ï¼ˆæœ€ã‚‚ä¿¡é ¼æ€§ãŒé«˜ã„ï¼‰
          CLAUDE_OUTPUT=""

          if [ -n "$CLAUDE_RESULT" ]; then
            echo "âœ… Using Claude result output directly"
            CLAUDE_OUTPUT="$CLAUDE_RESULT"
          elif [ -f "$EXECUTION_FILE" ]; then
            echo "ğŸ“‹ Fallback: Parsing execution file"
            echo "ğŸ“‹ JSON structure (keys):"
            jq 'keys' "$EXECUTION_FILE" 2>/dev/null || echo "(not a JSON object)"
            echo ""
            echo "ğŸ“‹ Full JSON (first 100 lines):"
            jq '.' "$EXECUTION_FILE" 2>/dev/null | head -100 || cat "$EXECUTION_FILE" | head -100

            # æ§˜ã€…ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™
            # Claude Code Actionã®å‡ºåŠ›å½¢å¼: é…åˆ—ã§ã€type="assistant"ã®è¦ç´ ã«message.content[].textãŒã‚ã‚‹
            CLAUDE_OUTPUT=$(jq -r '
              if type == "array" then
                # type == "assistant" ã®è¦ç´ ã‚’æ¢ã™ï¼ˆClaude Code Actionå½¢å¼ï¼‰
                (map(select(.type == "assistant")) | last | .message.content | map(select(.type == "text")) | .[0].text) //
                # role == "assistant" ã®è¦ç´ ã‚’æ¢ã™ï¼ˆæ—§å½¢å¼ï¼‰
                (map(select(.role == "assistant")) | last | .content | if type == "array" then map(select(.type == "text")) | .[0].text else . end) //
                # æœ€å¾Œã®è¦ç´ ã® result ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¢ã™
                (last | .result) //
                empty
              elif .result then
                .result
              elif .response then
                .response
              else
                empty
              end // empty
            ' "$EXECUTION_FILE" 2>/dev/null || echo "")
          else
            echo "âŒ No execution file and no result output"
          fi

          # ç©ºç™½ã®ã¿ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
          if [ -z "$(echo "$CLAUDE_OUTPUT" | tr -d '[:space:]')" ]; then
            echo "âš ï¸ Warning: Claude output is empty!"
          fi

          echo ""
          echo "ğŸ¤– Claude generated:"
          echo "========================================"
          echo "$CLAUDE_OUTPUT"
          echo "========================================"

          echo ""
          echo "ğŸ“‹ Suffix from prompt.md:"
          echo "$SUFFIX"

          # æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
          FINAL_PROMPT="${CLAUDE_OUTPUT} ${SUFFIX}"

          echo ""
          echo "ğŸ“ Final prompt:"
          echo "========================================"
          echo "$FINAL_PROMPT"
          echo "========================================"

          # GitHub Outputã«ä¿å­˜ï¼ˆheredocã‚’ä½¿ç”¨ã—ã¦æ”¹è¡Œã‚’ä¿æŒï¼‰
          {
            echo "prompt<<PROMPTEOF"
            echo "$FINAL_PROMPT"
            echo "PROMPTEOF"
          } >> $GITHUB_OUTPUT

          echo ""
          echo "âœ… Prompt saved to GITHUB_OUTPUT"

      - name: Summary
        env:
          PROMPT: ${{ steps.extract.outputs.prompt }}
        run: |
          echo "## ğŸ“ Prompt Generated by Claude" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$PROMPT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
