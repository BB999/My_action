name: Prompt Generator

on:
  workflow_call:
    outputs:
      prompt:
        description: 'Generated prompt'
        value: ${{ jobs.generate-prompt.outputs.prompt }}

permissions:
  id-token: write
  contents: read

jobs:
  generate-prompt:
    runs-on: ubuntu-latest
    outputs:
      prompt: ${{ steps.extract.outputs.prompt }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read prompt.md
        id: read_prompt
        run: |
          # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¬æ˜ã‚’æŠ½å‡ºï¼ˆâ“ªã®æ¬¡ã®è¡Œã‹ã‚‰â‘ ã®å‰ã¾ã§ï¼‰
          CHARACTER=$(sed -n '/^â“ª/,/^â‘ /{/^â“ª/d;/^â‘ /d;/^â”—/d;p}' prompt/prompt/prompt.md | tr -d '\n' | xargs)
          echo "character=$CHARACTER" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Character: $CHARACTER"

          # ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹ã‚’æŠ½å‡ºï¼ˆâ‘ ã®æ¬¡ã®è¡Œã‹ã‚‰â‘¡ã®å‰ã¾ã§ï¼‰
          EXAMPLE=$(sed -n '/^â‘ /,/^â‘¡/{/^â‘ /d;/^â‘¡/d;/^â”—/d;p}' prompt/prompt/prompt.md | tr -d '\n' | xargs)
          echo "example=$EXAMPLE" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Example: $EXAMPLE"

          # æ¥å°¾è¾ã‚’æŠ½å‡ºï¼ˆâ‘¡ã®æ¬¡ã®è¡Œã‹ã‚‰æœ€å¾Œã¾ã§ï¼‰
          SUFFIX=$(sed -n '/^â‘¡/,${/^â‘¡/d;/^â”—/d;p}' prompt/prompt/prompt.md | tr -d '\n' | xargs)
          echo "suffix=$SUFFIX" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Suffix: $SUFFIX"

      - name: Generate situation with Claude
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: agent
          direct_prompt: |
            Generate a unique, cinematic scene description for ${{ steps.read_prompt.outputs.character }} in a real Japanese location. Describe the character's posture, the environment, lighting, and atmosphere in 2-3 sentences. Be specific about body language and surroundings. Output ONLY the English description, no explanations or labels.

            Example style: ${{ steps.read_prompt.outputs.example }}

      - name: Extract and build prompt
        id: extract
        env:
          CLAUDE_OUTPUT: ${{ steps.claude.outputs.response }}
          SUFFIX: ${{ steps.read_prompt.outputs.suffix }}
        run: |
          echo "ğŸ¤– Claude generated:"
          echo "$CLAUDE_OUTPUT"

          echo "ğŸ“‹ Suffix from prompt.md:"
          echo "$SUFFIX"

          # æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
          FINAL_PROMPT="${CLAUDE_OUTPUT} ${SUFFIX}"

          echo ""
          echo "ğŸ“ Final prompt:"
          echo "$FINAL_PROMPT"

          # GitHub Outputã«ä¿å­˜
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$FINAL_PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Summary
        env:
          PROMPT: ${{ steps.extract.outputs.prompt }}
        run: |
          echo "## ğŸ“ Prompt Generated by Claude" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$PROMPT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
