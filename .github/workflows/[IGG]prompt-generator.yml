name: Prompt Generator

on:
  workflow_call:
    outputs:
      prompt:
        description: 'Generated prompt'
        value: ${{ jobs.generate-prompt.outputs.prompt }}

permissions:
  id-token: write
  contents: read

jobs:
  generate-prompt:
    runs-on: ubuntu-latest
    outputs:
      prompt: ${{ steps.final.outputs.prompt }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read prompt.md
        id: read_prompt
        run: |
          # „Ç≠„É£„É©„ÇØ„Çø„ÉºË™¨Êòé„ÇíÊäΩÂá∫Ôºà‚ì™„ÅÆÊ¨°„ÅÆË°å„Åã„Çâ‚ë†„ÅÆÂâç„Åæ„ÅßÔºâ
          CHARACTER=$(sed -n '/^‚ì™/,/^‚ë†/{/^‚ì™/d;/^‚ë†/d;/^‚îó/d;p}' prompt/prompt/prompt.md | tr '\n' ' ' | sed 's/^ *//;s/ *$//')
          echo "character=$CHARACTER" >> $GITHUB_OUTPUT
          echo "üìã Character: $CHARACTER"

          # Êé•Â∞æËæû„ÇíÊäΩÂá∫Ôºà‚ë†„ÅÆÊ¨°„ÅÆË°å„Åã„ÇâÊúÄÂæå„Åæ„ÅßÔºâ
          SUFFIX=$(sed -n '/^‚ë†/,${/^‚ë†/d;/^‚îó/d;p}' prompt/prompt/prompt.md | tr '\n' ' ' | sed 's/^ *//;s/ *$//')
          echo "suffix=$SUFFIX" >> $GITHUB_OUTPUT
          echo "üìã Suffix: $SUFFIX"

      # 1ÂõûÁõÆ„ÅÆË©¶Ë°å
      - name: Generate situation with Claude (Attempt 1)
        id: claude1
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: agent
          direct_prompt: |
            You are a creative writing assistant. Write a TEXT DESCRIPTION (not an image) of a unique scene featuring: ${{ steps.read_prompt.outputs.character }}

            Change the pose and location randomly while keeping the character's appearance. The scene should be energizing and inspiring. Output ONLY the scene description text, nothing else. No code, no explanations, just the descriptive text that could be used as an image generation prompt.

      - name: Check result 1
        id: check1
        env:
          CLAUDE_RESULT: ${{ steps.claude1.outputs.result }}
          EXECUTION_FILE: ${{ steps.claude1.outputs.execution_file }}
        run: |
          echo "üìÑ CLAUDE_RESULT length: ${#CLAUDE_RESULT}"
          echo "üìÑ EXECUTION_FILE: $EXECUTION_FILE"

          RESULT=""

          # „Åæ„ÅöresultÂá∫Âäõ„ÇíË©¶„Åô
          if [ -n "$CLAUDE_RESULT" ]; then
            RESULT="$CLAUDE_RESULT"
            echo "‚úÖ Using outputs.result"
          elif [ -f "$EXECUTION_FILE" ]; then
            echo "üìã Parsing execution file..."
            RESULT=$(jq -r '.result // empty' "$EXECUTION_FILE" 2>/dev/null || echo "")
            if [ -z "$RESULT" ]; then
              # ÈÖçÂàóÂΩ¢Âºè„ÅÆÂ†¥Âêà
              RESULT=$(jq -r 'if type == "array" then (map(select(.type == "result")) | last | .result) // empty else empty end' "$EXECUTION_FILE" 2>/dev/null || echo "")
            fi
            echo "‚úÖ Using execution_file"
          fi

          echo "üìÑ Final result length: ${#RESULT}"

          TRIMMED=$(echo "$RESULT" | tr -d '[:space:]')
          if [ -n "$TRIMMED" ]; then
            echo "‚úÖ Attempt 1: Success"
            echo "success=true" >> $GITHUB_OUTPUT
            {
              echo "result<<RESULTEOF"
              echo "$RESULT"
              echo "RESULTEOF"
            } >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Attempt 1: Empty output"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      # 2ÂõûÁõÆ„ÅÆË©¶Ë°åÔºà1ÂõûÁõÆ„ÅåÂ§±Êïó„Åó„ÅüÂ†¥ÂêàÔºâ
      - name: Generate situation with Claude (Attempt 2)
        id: claude2
        if: steps.check1.outputs.success != 'true'
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: agent
          direct_prompt: |
            You are a creative writing assistant. Write a TEXT DESCRIPTION (not an image) of a unique scene featuring: ${{ steps.read_prompt.outputs.character }}

            Change the pose and location randomly while keeping the character's appearance. The scene should be energizing and inspiring. Output ONLY the scene description text, nothing else. No code, no explanations, just the descriptive text that could be used as an image generation prompt.

      - name: Check result 2
        id: check2
        if: steps.check1.outputs.success != 'true'
        env:
          CLAUDE_RESULT: ${{ steps.claude2.outputs.result }}
          EXECUTION_FILE: ${{ steps.claude2.outputs.execution_file }}
        run: |
          echo "üìÑ CLAUDE_RESULT length: ${#CLAUDE_RESULT}"
          echo "üìÑ EXECUTION_FILE: $EXECUTION_FILE"

          RESULT=""

          if [ -n "$CLAUDE_RESULT" ]; then
            RESULT="$CLAUDE_RESULT"
            echo "‚úÖ Using outputs.result"
          elif [ -f "$EXECUTION_FILE" ]; then
            echo "üìã Parsing execution file..."
            RESULT=$(jq -r '.result // empty' "$EXECUTION_FILE" 2>/dev/null || echo "")
            if [ -z "$RESULT" ]; then
              RESULT=$(jq -r 'if type == "array" then (map(select(.type == "result")) | last | .result) // empty else empty end' "$EXECUTION_FILE" 2>/dev/null || echo "")
            fi
            echo "‚úÖ Using execution_file"
          fi

          echo "üìÑ Final result length: ${#RESULT}"

          TRIMMED=$(echo "$RESULT" | tr -d '[:space:]')
          if [ -n "$TRIMMED" ]; then
            echo "‚úÖ Attempt 2: Success"
            echo "success=true" >> $GITHUB_OUTPUT
            {
              echo "result<<RESULTEOF"
              echo "$RESULT"
              echo "RESULTEOF"
            } >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Attempt 2: Empty output"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      # 3ÂõûÁõÆ„ÅÆË©¶Ë°åÔºà2ÂõûÁõÆ„ÇÇÂ§±Êïó„Åó„ÅüÂ†¥ÂêàÔºâ
      - name: Generate situation with Claude (Attempt 3)
        id: claude3
        if: steps.check1.outputs.success != 'true' && steps.check2.outputs.success != 'true'
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: agent
          direct_prompt: |
            You are a creative writing assistant. Write a TEXT DESCRIPTION (not an image) of a unique scene featuring: ${{ steps.read_prompt.outputs.character }}

            Change the pose and location randomly while keeping the character's appearance. The scene should be energizing and inspiring. Output ONLY the scene description text, nothing else. No code, no explanations, just the descriptive text that could be used as an image generation prompt.

      - name: Check result 3
        id: check3
        if: steps.check1.outputs.success != 'true' && steps.check2.outputs.success != 'true'
        env:
          CLAUDE_RESULT: ${{ steps.claude3.outputs.result }}
          EXECUTION_FILE: ${{ steps.claude3.outputs.execution_file }}
        run: |
          echo "üìÑ CLAUDE_RESULT length: ${#CLAUDE_RESULT}"
          echo "üìÑ EXECUTION_FILE: $EXECUTION_FILE"

          RESULT=""

          if [ -n "$CLAUDE_RESULT" ]; then
            RESULT="$CLAUDE_RESULT"
            echo "‚úÖ Using outputs.result"
          elif [ -f "$EXECUTION_FILE" ]; then
            echo "üìã Parsing execution file..."
            RESULT=$(jq -r '.result // empty' "$EXECUTION_FILE" 2>/dev/null || echo "")
            if [ -z "$RESULT" ]; then
              RESULT=$(jq -r 'if type == "array" then (map(select(.type == "result")) | last | .result) // empty else empty end' "$EXECUTION_FILE" 2>/dev/null || echo "")
            fi
            echo "‚úÖ Using execution_file"
          fi

          echo "üìÑ Final result length: ${#RESULT}"

          TRIMMED=$(echo "$RESULT" | tr -d '[:space:]')
          if [ -n "$TRIMMED" ]; then
            echo "‚úÖ Attempt 3: Success"
            echo "success=true" >> $GITHUB_OUTPUT
            {
              echo "result<<RESULTEOF"
              echo "$RESULT"
              echo "RESULTEOF"
            } >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Attempt 3: Empty output"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      # ÊúÄÁµÇÁµêÊûú„ÅÆÂá¶ÁêÜ
      - name: Build final prompt
        id: final
        env:
          RESULT1: ${{ steps.check1.outputs.result }}
          RESULT2: ${{ steps.check2.outputs.result }}
          RESULT3: ${{ steps.check3.outputs.result }}
          SUCCESS1: ${{ steps.check1.outputs.success }}
          SUCCESS2: ${{ steps.check2.outputs.success }}
          SUCCESS3: ${{ steps.check3.outputs.success }}
          SUFFIX: ${{ steps.read_prompt.outputs.suffix }}
        run: |
          echo "üìä Results summary:"
          echo "  - Attempt 1: $SUCCESS1"
          echo "  - Attempt 2: $SUCCESS2"
          echo "  - Attempt 3: $SUCCESS3"

          CLAUDE_OUTPUT=""

          if [ "$SUCCESS1" = "true" ]; then
            echo "‚úÖ Using result from attempt 1"
            CLAUDE_OUTPUT="$RESULT1"
          elif [ "$SUCCESS2" = "true" ]; then
            echo "‚úÖ Using result from attempt 2"
            CLAUDE_OUTPUT="$RESULT2"
          elif [ "$SUCCESS3" = "true" ]; then
            echo "‚úÖ Using result from attempt 3"
            CLAUDE_OUTPUT="$RESULT3"
          else
            echo ""
            echo "‚ùå‚ùå‚ùå ERROR: All 3 attempts failed to generate prompt ‚ùå‚ùå‚ùå"
            echo ""
            echo "üìã Debug information:"
            echo "  - Attempt 1 result length: ${#RESULT1}"
            echo "  - Attempt 2 result length: ${#RESULT2}"
            echo "  - Attempt 3 result length: ${#RESULT3}"
            echo ""
            echo "Claude output was empty on all attempts."
            echo "Please check the Claude Code Action logs above for more details."
            exit 1
          fi

          echo ""
          echo "ü§ñ Claude generated:"
          echo "========================================"
          echo "$CLAUDE_OUTPUT"
          echo "========================================"

          echo ""
          echo "üìã Suffix from prompt.md:"
          echo "$SUFFIX"

          # ÊúÄÁµÇ„Éó„É≠„É≥„Éó„Éà„ÇíÁîüÊàê
          FINAL_PROMPT="${CLAUDE_OUTPUT} ${SUFFIX}"

          echo ""
          echo "üìù Final prompt:"
          echo "========================================"
          echo "$FINAL_PROMPT"
          echo "========================================"

          # GitHub Output„Å´‰øùÂ≠òÔºàheredoc„Çí‰ΩøÁî®„Åó„Å¶ÊîπË°å„Çí‰øùÊåÅÔºâ
          {
            echo "prompt<<PROMPTEOF"
            echo "$FINAL_PROMPT"
            echo "PROMPTEOF"
          } >> $GITHUB_OUTPUT

          echo ""
          echo "‚úÖ Prompt saved to GITHUB_OUTPUT"

      - name: Summary
        env:
          PROMPT: ${{ steps.final.outputs.prompt }}
        run: |
          echo "## üìù Prompt Generated by Claude" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$PROMPT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
