name: "[IGG] Prompt Generator"

on:
  workflow_call:
    outputs:
      prompt:
        description: 'Generated prompt'
        value: ${{ jobs.generate-prompt.outputs.prompt }}
      prompt_ja:
        description: 'Generated prompt in Japanese'
        value: ${{ jobs.generate-prompt.outputs.prompt_ja }}

permissions:
  id-token: write
  contents: read

jobs:
  generate-prompt:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      prompt: ${{ steps.final.outputs.prompt }}
      prompt_ja: ${{ steps.translate.outputs.prompt_ja }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read prompt.md
        id: read_prompt
        run: |
          # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¬æ˜ã‚’æŠ½å‡ºï¼ˆâ“ªã®æ¬¡ã®è¡Œã‹ã‚‰â‘ ã®å‰ã¾ã§ï¼‰
          CHARACTER=$(sed -n '/^â“ª/,/^â‘ /{/^â“ª/d;/^â‘ /d;/^â”—/d;p}' prompt/prompt/prompt.md | tr '\n' ' ' | sed 's/^ *//;s/ *$//')
          echo "character=$CHARACTER" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Character: $CHARACTER"

          # æ¥å°¾è¾ã‚’æŠ½å‡ºï¼ˆâ‘ ã®æ¬¡ã®è¡Œã‹ã‚‰â‘¡ã®å‰ã¾ã§ï¼‰
          SUFFIX=$(sed -n '/^â‘ /,/^â‘¡/{/^â‘ /d;/^â‘¡/d;/^â”—/d;p}' prompt/prompt/prompt.md | tr '\n' ' ' | sed 's/^ *//;s/ *$//')
          echo "suffix=$SUFFIX" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Suffix: $SUFFIX"

          # Claudeã¸ã®æŒ‡ç¤ºã‚’æŠ½å‡ºï¼ˆâ‘¡ã®æ¬¡ã®è¡Œã‹ã‚‰æœ€å¾Œã¾ã§ï¼‰
          CLAUDE_INSTRUCTION=$(sed -n '/^â‘¡/,${/^â‘¡/d;/^â”—/d;p}' prompt/prompt/prompt.md | tr '\n' ' ' | sed 's/^ *//;s/ *$//')
          echo "claude_instruction=$CLAUDE_INSTRUCTION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Claude Instruction: $CLAUDE_INSTRUCTION"

      # 1å›ç›®ã®è©¦è¡Œ
      - name: Generate situation with Claude (Attempt 1)
        id: claude1
        timeout-minutes: 5
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: agent
          direct_prompt: |
            Character: ${{ steps.read_prompt.outputs.character }}

            ${{ steps.read_prompt.outputs.claude_instruction }}

      - name: Check result 1
        id: check1
        env:
          CLAUDE_RESULT: ${{ steps.claude1.outputs.result }}
          EXECUTION_FILE: ${{ steps.claude1.outputs.execution_file }}
        run: |
          echo "ğŸ“„ CLAUDE_RESULT length: ${#CLAUDE_RESULT}"
          echo "ğŸ“„ EXECUTION_FILE: $EXECUTION_FILE"

          RESULT=""

          # ã¾ãšresultå‡ºåŠ›ã‚’è©¦ã™
          if [ -n "$CLAUDE_RESULT" ]; then
            RESULT="$CLAUDE_RESULT"
            echo "âœ… Using outputs.result"
          elif [ -f "$EXECUTION_FILE" ]; then
            echo "ğŸ“‹ Parsing execution file..."
            RESULT=$(jq -r '.result // empty' "$EXECUTION_FILE" 2>/dev/null || echo "")
            if [ -z "$RESULT" ]; then
              # é…åˆ—å½¢å¼ã®å ´åˆ
              RESULT=$(jq -r 'if type == "array" then (map(select(.type == "result")) | last | .result) // empty else empty end' "$EXECUTION_FILE" 2>/dev/null || echo "")
            fi
            echo "âœ… Using execution_file"
          fi

          echo "ğŸ“„ Final result length: ${#RESULT}"

          TRIMMED=$(echo "$RESULT" | tr -d '[:space:]')
          if [ -n "$TRIMMED" ]; then
            echo "âœ… Attempt 1: Success"
            echo "success=true" >> $GITHUB_OUTPUT
            {
              echo "result<<RESULTEOF"
              echo "$RESULT"
              echo "RESULTEOF"
            } >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Attempt 1: Empty output"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      # 2å›ç›®ã®è©¦è¡Œï¼ˆ1å›ç›®ãŒå¤±æ•—ã—ãŸå ´åˆï¼‰
      - name: Generate situation with Claude (Attempt 2)
        id: claude2
        timeout-minutes: 5
        if: steps.check1.outputs.success != 'true'
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: agent
          direct_prompt: |
            Character: ${{ steps.read_prompt.outputs.character }}

            ${{ steps.read_prompt.outputs.claude_instruction }}

      - name: Check result 2
        id: check2
        if: steps.check1.outputs.success != 'true'
        env:
          CLAUDE_RESULT: ${{ steps.claude2.outputs.result }}
          EXECUTION_FILE: ${{ steps.claude2.outputs.execution_file }}
        run: |
          echo "ğŸ“„ CLAUDE_RESULT length: ${#CLAUDE_RESULT}"
          echo "ğŸ“„ EXECUTION_FILE: $EXECUTION_FILE"

          RESULT=""

          if [ -n "$CLAUDE_RESULT" ]; then
            RESULT="$CLAUDE_RESULT"
            echo "âœ… Using outputs.result"
          elif [ -f "$EXECUTION_FILE" ]; then
            echo "ğŸ“‹ Parsing execution file..."
            RESULT=$(jq -r '.result // empty' "$EXECUTION_FILE" 2>/dev/null || echo "")
            if [ -z "$RESULT" ]; then
              RESULT=$(jq -r 'if type == "array" then (map(select(.type == "result")) | last | .result) // empty else empty end' "$EXECUTION_FILE" 2>/dev/null || echo "")
            fi
            echo "âœ… Using execution_file"
          fi

          echo "ğŸ“„ Final result length: ${#RESULT}"

          TRIMMED=$(echo "$RESULT" | tr -d '[:space:]')
          if [ -n "$TRIMMED" ]; then
            echo "âœ… Attempt 2: Success"
            echo "success=true" >> $GITHUB_OUTPUT
            {
              echo "result<<RESULTEOF"
              echo "$RESULT"
              echo "RESULTEOF"
            } >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Attempt 2: Empty output"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      # 3å›ç›®ã®è©¦è¡Œï¼ˆ2å›ç›®ã‚‚å¤±æ•—ã—ãŸå ´åˆï¼‰
      - name: Generate situation with Claude (Attempt 3)
        id: claude3
        timeout-minutes: 5
        if: steps.check1.outputs.success != 'true' && steps.check2.outputs.success != 'true'
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: agent
          direct_prompt: |
            Character: ${{ steps.read_prompt.outputs.character }}

            ${{ steps.read_prompt.outputs.claude_instruction }}

      - name: Check result 3
        id: check3
        if: steps.check1.outputs.success != 'true' && steps.check2.outputs.success != 'true'
        env:
          CLAUDE_RESULT: ${{ steps.claude3.outputs.result }}
          EXECUTION_FILE: ${{ steps.claude3.outputs.execution_file }}
        run: |
          echo "ğŸ“„ CLAUDE_RESULT length: ${#CLAUDE_RESULT}"
          echo "ğŸ“„ EXECUTION_FILE: $EXECUTION_FILE"

          RESULT=""

          if [ -n "$CLAUDE_RESULT" ]; then
            RESULT="$CLAUDE_RESULT"
            echo "âœ… Using outputs.result"
          elif [ -f "$EXECUTION_FILE" ]; then
            echo "ğŸ“‹ Parsing execution file..."
            RESULT=$(jq -r '.result // empty' "$EXECUTION_FILE" 2>/dev/null || echo "")
            if [ -z "$RESULT" ]; then
              RESULT=$(jq -r 'if type == "array" then (map(select(.type == "result")) | last | .result) // empty else empty end' "$EXECUTION_FILE" 2>/dev/null || echo "")
            fi
            echo "âœ… Using execution_file"
          fi

          echo "ğŸ“„ Final result length: ${#RESULT}"

          TRIMMED=$(echo "$RESULT" | tr -d '[:space:]')
          if [ -n "$TRIMMED" ]; then
            echo "âœ… Attempt 3: Success"
            echo "success=true" >> $GITHUB_OUTPUT
            {
              echo "result<<RESULTEOF"
              echo "$RESULT"
              echo "RESULTEOF"
            } >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Attempt 3: Empty output"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      # æœ€çµ‚çµæœã®å‡¦ç†
      - name: Build final prompt
        id: final
        env:
          RESULT1: ${{ steps.check1.outputs.result }}
          RESULT2: ${{ steps.check2.outputs.result }}
          RESULT3: ${{ steps.check3.outputs.result }}
          SUCCESS1: ${{ steps.check1.outputs.success }}
          SUCCESS2: ${{ steps.check2.outputs.success }}
          SUCCESS3: ${{ steps.check3.outputs.success }}
          SUFFIX: ${{ steps.read_prompt.outputs.suffix }}
        run: |
          echo "ğŸ“Š Results summary:"
          echo "  - Attempt 1: $SUCCESS1"
          echo "  - Attempt 2: $SUCCESS2"
          echo "  - Attempt 3: $SUCCESS3"

          CLAUDE_OUTPUT=""

          if [ "$SUCCESS1" = "true" ]; then
            echo "âœ… Using result from attempt 1"
            CLAUDE_OUTPUT="$RESULT1"
          elif [ "$SUCCESS2" = "true" ]; then
            echo "âœ… Using result from attempt 2"
            CLAUDE_OUTPUT="$RESULT2"
          elif [ "$SUCCESS3" = "true" ]; then
            echo "âœ… Using result from attempt 3"
            CLAUDE_OUTPUT="$RESULT3"
          else
            echo ""
            echo "âŒâŒâŒ ERROR: All 3 attempts failed to generate prompt âŒâŒâŒ"
            echo ""
            echo "ğŸ“‹ Debug information:"
            echo "  - Attempt 1 result length: ${#RESULT1}"
            echo "  - Attempt 2 result length: ${#RESULT2}"
            echo "  - Attempt 3 result length: ${#RESULT3}"
            echo ""
            echo "Claude output was empty on all attempts."
            echo "Please check the Claude Code Action logs above for more details."
            exit 1
          fi

          echo ""
          echo "ğŸ¤– Claude generated:"
          echo "========================================"
          echo "$CLAUDE_OUTPUT"
          echo "========================================"

          echo ""
          echo "ğŸ“‹ Suffix from prompt.md:"
          echo "$SUFFIX"

          # æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
          FINAL_PROMPT="${CLAUDE_OUTPUT} ${SUFFIX}"

          echo ""
          echo "ğŸ“ Final prompt:"
          echo "========================================"
          echo "$FINAL_PROMPT"
          echo "========================================"

          # GitHub Outputã«ä¿å­˜ï¼ˆheredocã‚’ä½¿ç”¨ã—ã¦æ”¹è¡Œã‚’ä¿æŒï¼‰
          {
            echo "prompt<<PROMPTEOF"
            echo "$FINAL_PROMPT"
            echo "PROMPTEOF"
          } >> $GITHUB_OUTPUT

          echo ""
          echo "âœ… Prompt saved to GITHUB_OUTPUT"

      # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ—¥æœ¬èªã«ç¿»è¨³
      - name: Translate prompt to Japanese
        id: translate_claude
        timeout-minutes: 5
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          mode: agent
          direct_prompt: |
            Translate the following English image prompt to Japanese. Output ONLY the Japanese translation, nothing else. No explanations, no code.

            ${{ steps.final.outputs.prompt }}

      - name: Extract translation
        id: translate
        env:
          CLAUDE_RESULT: ${{ steps.translate_claude.outputs.result }}
          EXECUTION_FILE: ${{ steps.translate_claude.outputs.execution_file }}
        run: |
          RESULT=""

          if [ -n "$CLAUDE_RESULT" ]; then
            RESULT="$CLAUDE_RESULT"
          elif [ -f "$EXECUTION_FILE" ]; then
            RESULT=$(jq -r '.result // empty' "$EXECUTION_FILE" 2>/dev/null || echo "")
            if [ -z "$RESULT" ]; then
              RESULT=$(jq -r 'if type == "array" then (map(select(.type == "result")) | last | .result) // empty else empty end' "$EXECUTION_FILE" 2>/dev/null || echo "")
            fi
          fi

          if [ -z "$RESULT" ]; then
            RESULT="(ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸ)"
          fi

          echo "ğŸ‡¯ğŸ‡µ Japanese translation:"
          echo "$RESULT"

          {
            echo "prompt_ja<<JAEOF"
            echo "$RESULT"
            echo "JAEOF"
          } >> $GITHUB_OUTPUT

      - name: Summary
        env:
          PROMPT: ${{ steps.final.outputs.prompt }}
          PROMPT_JA: ${{ steps.translate.outputs.prompt_ja }}
        run: |
          echo "## ğŸ“ Prompt Generated by Claude" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### English" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$PROMPT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ—¥æœ¬èª" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$PROMPT_JA" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
