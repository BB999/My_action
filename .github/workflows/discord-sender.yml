name: Discord Sender Module

on:
  workflow_call:
    inputs:
      message:
        description: 'Discordã«é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'
        required: true
        type: string
      artifact-name:
        description: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå'
        required: false
        type: string
        default: 'edited-images'
      embed-title:
        description: 'åŸ‹ã‚è¾¼ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
      embed-description:
        description: 'åŸ‹ã‚è¾¼ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª¬æ˜ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
      embed-color:
        description: 'åŸ‹ã‚è¾¼ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è‰²ï¼ˆ16é€²æ•°ã€ä»»æ„ï¼‰'
        required: false
        type: string
        default: '0099ff'

jobs:
  send-to-discord:
    runs-on: ubuntu-latest

    steps:
    - name: Download Image Artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact-name }}
        path: ./images
      continue-on-error: true

    - name: Check Downloaded Files
      run: |
        echo "ğŸ“ Checking for images..."
        ls -la ./images/ 2>/dev/null || echo "No images directory"
        find . -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" \) | head -10

    - name: Send images to Discord
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        MESSAGE: ${{ inputs.message }}
      run: |
        echo "ğŸ“¤ Sending to Discord..."

        # WebhookURLã®ç¢ºèª
        if [ -z "$DISCORD_WEBHOOK_URL" ]; then
          echo "âŒ DISCORD_WEBHOOK_URL is not set"
          exit 1
        fi
        echo "âœ… Webhook URL is set"
        echo "ğŸ”— URL prefix: ${DISCORD_WEBHOOK_URL:0:40}..."
        echo "ğŸ“ URL length: ${#DISCORD_WEBHOOK_URL}"

        # ä¸æ­£ãªæ–‡å­—ã‚’ãƒã‚§ãƒƒã‚¯
        echo "ğŸ” URL hex dump (first 50 chars):"
        echo "${DISCORD_WEBHOOK_URL:0:50}" | xxd | head -3

        # æ”¹è¡Œã‚„ç©ºç™½ã‚’é™¤å»
        DISCORD_WEBHOOK_URL=$(echo "$DISCORD_WEBHOOK_URL" | tr -d '\n\r\t ' | sed 's/[[:space:]]//g')
        echo "ğŸ“ Cleaned URL length: ${#DISCORD_WEBHOOK_URL}"

        # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
        IMAGES=$(find ./images -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" \) 2>/dev/null | head -10)

        if [ -z "$IMAGES" ]; then
          echo "âš ï¸ No images found, sending message only"
          JSON_PAYLOAD=$(jq -n --arg content "$MESSAGE" '{content: $content}')
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "$DISCORD_WEBHOOK_URL"
        else
          # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’Discordã«é€ä¿¡
          for img in $IMAGES; do
            if [ -f "$img" ]; then
              echo "ğŸ“· Sending: $img"
              echo "ğŸ“ File size: $(ls -lh "$img" | awk '{print $5}')"

              # discordapp.com ã‚’ discord.com ã«å¤‰æ›
              WEBHOOK_URL="${DISCORD_WEBHOOK_URL/discordapp.com/discord.com}"

              HTTP_CODE=$(curl -sS -w "%{http_code}" -o /tmp/response.txt -X POST \
                -F "content=$MESSAGE" \
                -F "file=@$img" \
                "$WEBHOOK_URL" 2>&1) || true

              echo "ğŸ“¥ Curl output: $HTTP_CODE"
              HTTP_CODE=$(echo "$HTTP_CODE" | tail -c 4 | head -c 3)

              echo "ğŸ“¥ HTTP Status: $HTTP_CODE"
              if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "204" ]; then
                echo "âŒ Response: $(cat /tmp/response.txt 2>/dev/null || echo 'No response')"
              else
                echo "âœ… Sent: $img"
              fi
              # ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
              sleep 1
            fi
          done
        fi

        echo "âœ… Discordé€ä¿¡å®Œäº†"

    - name: Send embed to Discord
      if: ${{ inputs.embed-title != '' && inputs.embed-description != '' }}
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        curl -s -H "Content-Type: application/json" \
             -d "{\"embeds\": [{\"title\": \"${{ inputs.embed-title }}\", \"description\": \"${{ inputs.embed-description }}\", \"color\": ${{ inputs.embed-color }}, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}" \
             "$DISCORD_WEBHOOK_URL"
